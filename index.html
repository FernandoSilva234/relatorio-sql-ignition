<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Relatório Técnico - SQL + Ignition</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>Relatório Técnico</h1>
        <p><strong>Projeto:</strong> Integração Ignition + SQL Server</p>
        <p><strong>Objetivo:</strong> Estruturar base histórica de medições, consultas e comandos de escrita/leitura.</p>
    </header>

    <section>
        <h2>1. Estrutura da Tabela</h2>
        <pre><code class="sql">
CREATE TABLE MeasurementsNumeric (
    measurement_id INT IDENTITY(1,1) PRIMARY KEY,
    tag_id INT NOT NULL,
    ts_utc DATETIME2 NOT NULL,
    value FLOAT NOT NULL,
    CONSTRAINT FK_Tag FOREIGN KEY (tag_id) REFERENCES Tags(tag_id)
);

CREATE TABLE MeasurementsBool (
    measurement_id INT IDENTITY(1,1) PRIMARY KEY,
    tag_id INT NOT NULL,
    ts_utc DATETIME2 NOT NULL,
    value BIT NOT NULL,
    CONSTRAINT FK_Tag_Bool FOREIGN KEY (tag_id) REFERENCES Tags(tag_id)
);
        </code></pre>
    </section>

    <section>
        <h2>2. Views Criadas</h2>
        <h3>Últimos valores numéricos</h3>
        <pre><code class="sql">
CREATE VIEW v_LatestNumeric AS
SELECT m.tag_id, a.name AS asset_name, t.name AS tag_name,
       t.eng_unit, m.ts_utc, m.value
FROM MeasurementsNumeric m
JOIN Tags t   ON t.tag_id = m.tag_id
JOIN Assets a ON a.asset_id = t.asset_id
WHERE m.ts_utc = (
    SELECT MAX(m2.ts_utc)
    FROM MeasurementsNumeric m2
    WHERE m2.tag_id = m.tag_id
);
        </code></pre>

        <h3>Últimos valores booleanos</h3>
        <pre><code class="sql">
CREATE VIEW v_LatestBool AS
SELECT m.tag_id, a.name AS asset_name, t.name AS tag_name,
       NULL AS eng_unit, m.ts_utc,
       CAST(m.value AS DECIMAL(18,6)) AS value
FROM MeasurementsBool m
JOIN Tags t   ON t.tag_id = m.tag_id
JOIN Assets a ON a.asset_id = t.asset_id
WHERE m.ts_utc = (
    SELECT MAX(m2.ts_utc)
    FROM MeasurementsBool m2
    WHERE m2.tag_id = m.tag_id
);
        </code></pre>
    </section>

    <section>
        <h2>3. Queries de Leitura</h2>
        <h3>Leitura geral de todos os valores</h3>
        <pre><code class="sql">
SELECT * FROM v_LatestNumeric
UNION ALL
SELECT * FROM v_LatestBool;
        </code></pre>

        <h3>Leitura por ativo (asset)</h3>
        <pre><code class="sql">
SELECT tag_id, asset_name, tag_name, eng_unit, ts_utc, value
FROM v_LatestNumeric
WHERE asset_name = :asset_name
UNION ALL
SELECT tag_id, asset_name, tag_name, NULL AS eng_unit, ts_utc,
       CAST(value AS DECIMAL(18,6)) AS value
FROM v_LatestBool
WHERE asset_name = :asset_name
ORDER BY tag_name;
        </code></pre>
    </section>

    <section>
        <h2>4. Queries de Escrita</h2>
        <h3>Inserção em valores numéricos</h3>
        <pre><code class="sql">
INSERT INTO MeasurementsNumeric (tag_id, ts_utc, value)
VALUES (
    (SELECT tag_id FROM Tags WHERE name = :tag_name),
    :ts_utc,
    :value
);
        </code></pre>

        <h3>Inserção em valores booleanos</h3>
        <pre><code class="sql">
INSERT INTO MeasurementsBool (tag_id, ts_utc, value)
VALUES (
    (SELECT tag_id FROM Tags WHERE name = :tag_name),
    :ts_utc,
    :value
);
        </code></pre>
    </section>

    <footer>
        <p><em>Relatório gerado como base de estudo e apresentação técnica.</em></p>
    </footer>
</body>
</html>
